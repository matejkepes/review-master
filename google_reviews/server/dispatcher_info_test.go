package server

import (
	"encoding/json"
	"fmt"
	"log"
	"testing"
)

const respBookingNowOk = "{\"version\":243,\"code\":\"0\",\"body\":{\"booking\":{\"id\":\"3461787\",\"perma_id\":\"3408120\",\"sequence\":\"1\",\"trip_id\":\"3408120A\",\"created_date\":\"2019-11-04T12:35:02+00:00\",\"date\":\"2019-11-04T12:35:02+00:00\",\"pickup_date\":\"2019-11-04T12:35:02+00:00\",\"eta\":\"7\",\"expected_arrival_at\":\"2019-11-04T12:42:02+00:00\",\"booked_date\":\"2019-11-04T12:35:09+00:00\",\"arrive_date\":\"2019-11-04T12:37:29+00:00\",\"contact_date\":\"2019-11-04T12:39:18+00:00\",\"close_date\":\"2019-11-04T12:54:46+00:00\",\"operator_id\":\"0\",\"user_id\":\"2129298\",\"name\":\"ANGELA\",\"phone\":\"00447743064497\",\"account_id\":\"0\",\"account\":[],\"flight_number\":null,\"payment\":{\"id\":\"3508679\",\"tip\":0,\"tip_type\":\"ABSOLUTE\",\"tolls\":0,\"extras\":0,\"cost\":7.1,\"price\":7.1,\"fixed\":0,\"service_charge\":0,\"total\":7.1,\"order_id\":\"0\",\"card_id\":0,\"status\":\"PROCESSED\",\"fixedfare_id\":0,\"fixedfare\":[],\"fixedfare_alt\":0,\"tariff_id\":1,\"waiting\":0,\"waiting_cost\":0,\"waiting_price\":0,\"fee\":0,\"processed\":\"2019-11-04T12:54:46+00:00\",\"service_charge_value\":0,\"service_charge_type\":\"\",\"min_service_charge\":0,\"discount_price\":0,\"discount_price_type\":\"PERCENTAGE\",\"discount_cost\":0,\"discount_cost_type\":\"PERCENTAGE\",\"distance_charged\":3.6485,\"profile\":\"NORMAL\",\"driver_collects\":0,\"_deprecated_fields_\":[\"meter\",\"account_meter\",\"processing_fee\"],\"meter\":7.1,\"account_meter\":7.1,\"processing_fee\":0,\"voucher\":\"\",\"passengers\":0,\"discount\":0,\"price_after_discount\":7.1,\"cardpayments\":[]},\"payment_type\":\"CASH\",\"zone_id\":17,\"zone\":{\"id\":17,\"ref\":\"BOOTH NORTH\"},\"address\":{\"id\":\"11783992\",\"lat\":53.739643,\"lng\":-0.414043,\"actual_lat\":53.739643,\"actual_lng\":-0.414043,\"formatted\":\"38 ROKEBY AVENUE, HULL, HULL, HU47NA\",\"building_number\":\"38\",\"street\":\"ROKEBY AVENUE\",\"postcode\":\"HU47NA\"},\"destination\":{\"id\":\"11760120\",\"formatted\":\"BROOK STREET, HULL, HU28LA\",\"lat\":53.746079,\"lng\":-0.344922,\"actual_lat\":53.746079,\"actual_lng\":-0.344922,\"building_number\":null,\"street\":\"BROOK STREET\",\"postcode\":\"HU28LA\"},\"vehicle_type\":\"R4\",\"vehicle_group\":\"Taxi\",\"instructions\":\"\",\"driver_comment\":\"\",\"notes\":\" \",\"driver\":{\"id\":214,\"ref\":\"255\",\"active\":\"1\",\"name\":\"Steve Wiles\",\"mobile\":\"00447734469587\",\"email\":\"sophiewiles88@gmail.com\",\"photo\":\"https:\\/\\/s3-eu-west-1.amazonaws.com\\/icabbi.assets\\/images\\/consumergeneral\\/driver.png\",\"psv\":\"982\",\"psv_expiry\":\"2017-06-30T23:00:00+00:00\",\"badge_type\":\"PRIVATE HIRE\",\"licence\":\"\",\"licence_expiry\":\"2017-04-20T15:10:00+00:00\",\"last_payment_date\":\"2017-04-20T15:10:00+00:00\",\"lat\":null,\"lng\":null,\"deleted\":\"0\",\"phone\":\"00447391685806\",\"vehicle\":{\"id\":\"220\",\"ref\":\"255\",\"a_k_a\":\"\",\"year\":\"2016\",\"reg\":\"sm66cmk\",\"plate\":\"309\",\"plate_expiry\":\"2017-12-04T00:00:00+00:00\",\"hire_expiry\":\"2017-05-03T09:11:00+00:00\",\"insurer\":null,\"insurance\":null,\"insurance_expiry\":\"2017-05-31T23:00:00+00:00\",\"nct\":null,\"nct_expiry\":\"2017-05-03T09:11:00+00:00\",\"road_tax_expiry\":\"2017-05-03T09:11:00+00:00\",\"make\":\"hyundai\",\"model\":\"i40\",\"colour\":\"grey\",\"vehicle_phone\":null}},\"vehicle\":{\"id\":\"220\",\"ref\":\"255\",\"a_k_a\":\"\",\"year\":\"2016\",\"reg\":\"sm66cmk\",\"plate\":\"309\",\"plate_expiry\":\"2017-12-04T00:00:00+00:00\",\"hire_expiry\":\"2017-05-03T09:11:00+00:00\",\"insurer\":null,\"insurance\":null,\"insurance_expiry\":\"2017-05-31T23:00:00+00:00\",\"nct\":null,\"nct_expiry\":\"2017-05-03T09:11:00+00:00\",\"road_tax_expiry\":\"2017-05-03T09:11:00+00:00\",\"make\":\"hyundai\",\"model\":\"i40\",\"colour\":\"grey\",\"vehicle_phone\":null},\"priority\":\"4\",\"attributegroup_id\":\"1\",\"site_id\":\"0\",\"fail_count\":\"0\",\"source\":\"IVR\",\"status\":\"COMPLETED\",\"status_text\":\"Your booking has been completed.\",\"fields\":[],\"vias\":[{\"id\":\"6587476\",\"lat\":53.739643,\"lng\":-0.414043,\"formatted\":\"38 Rokeby Avenue, Hull, Hull, Hu47na\",\"pickup_order\":\"1\",\"pickup_date\":null,\"name\":\"ANGELA\",\"type\":\"PICKUP\",\"phone\":\"00447743064497\",\"custom-fields\":[]}],\"route\":{\"actual\":\"3.65\",\"estimate\":\"0.00\",\"actual_duration\":\"00:19:37\",\"estimate_duration\":\"00:00:00\"},\"prebooked\":0,\"company\":\"57 Taxis Limited T\\/A Drive\",\"bookingreferrer\":null,\"_object_type\":\"archive\",\"language\":\"\",\"CO2_emissions\":441,\"unit\":\"g\\/km\"}},\"warnings\":[],\"nonce\":null}"
const respBookingNowNotOk = "{\"version\":243,\"code\":\"0\",\"body\":{\"booking\":{\"id\":\"3461787\",\"perma_id\":\"3408120\",\"sequence\":\"1\",\"trip_id\":\"3408120A\",\"created_date\":\"2019-11-04T12:35:02+00:00\",\"date\":\"2019-11-04T12:35:02+00:00\",\"pickup_date\":\"2019-11-04T12:35:02+00:00\",\"eta\":\"7\",\"expected_arrival_at\":\"2019-11-04T12:42:02+00:00\",\"booked_date\":\"2019-11-04T12:35:09+00:00\",\"arrive_date\":\"2019-11-04T12:47:29+00:00\",\"contact_date\":\"2019-11-04T12:49:18+00:00\",\"close_date\":\"2019-11-04T12:54:46+00:00\",\"operator_id\":\"0\",\"user_id\":\"2129298\",\"name\":\"ANGELA\",\"phone\":\"00447743064497\",\"account_id\":\"0\",\"account\":[],\"flight_number\":null,\"payment\":{\"id\":\"3508679\",\"tip\":0,\"tip_type\":\"ABSOLUTE\",\"tolls\":0,\"extras\":0,\"cost\":7.1,\"price\":7.1,\"fixed\":0,\"service_charge\":0,\"total\":7.1,\"order_id\":\"0\",\"card_id\":0,\"status\":\"PROCESSED\",\"fixedfare_id\":0,\"fixedfare\":[],\"fixedfare_alt\":0,\"tariff_id\":1,\"waiting\":0,\"waiting_cost\":0,\"waiting_price\":0,\"fee\":0,\"processed\":\"2019-11-04T12:54:46+00:00\",\"service_charge_value\":0,\"service_charge_type\":\"\",\"min_service_charge\":0,\"discount_price\":0,\"discount_price_type\":\"PERCENTAGE\",\"discount_cost\":0,\"discount_cost_type\":\"PERCENTAGE\",\"distance_charged\":3.6485,\"profile\":\"NORMAL\",\"driver_collects\":0,\"_deprecated_fields_\":[\"meter\",\"account_meter\",\"processing_fee\"],\"meter\":7.1,\"account_meter\":7.1,\"processing_fee\":0,\"voucher\":\"\",\"passengers\":0,\"discount\":0,\"price_after_discount\":7.1,\"cardpayments\":[]},\"payment_type\":\"CASH\",\"zone_id\":17,\"zone\":{\"id\":17,\"ref\":\"BOOTH NORTH\"},\"address\":{\"id\":\"11783992\",\"lat\":53.739643,\"lng\":-0.414043,\"actual_lat\":53.739643,\"actual_lng\":-0.414043,\"formatted\":\"38 ROKEBY AVENUE, HULL, HULL, HU47NA\",\"building_number\":\"38\",\"street\":\"ROKEBY AVENUE\",\"postcode\":\"HU47NA\"},\"destination\":{\"id\":\"11760120\",\"formatted\":\"BROOK STREET, HULL, HU28LA\",\"lat\":53.746079,\"lng\":-0.344922,\"actual_lat\":53.746079,\"actual_lng\":-0.344922,\"building_number\":null,\"street\":\"BROOK STREET\",\"postcode\":\"HU28LA\"},\"vehicle_type\":\"R4\",\"vehicle_group\":\"Taxi\",\"instructions\":\"\",\"driver_comment\":\"\",\"notes\":\" \",\"driver\":{\"id\":214,\"ref\":\"255\",\"active\":\"1\",\"name\":\"Steve Wiles\",\"mobile\":\"00447734469587\",\"email\":\"sophiewiles88@gmail.com\",\"photo\":\"https:\\/\\/s3-eu-west-1.amazonaws.com\\/icabbi.assets\\/images\\/consumergeneral\\/driver.png\",\"psv\":\"982\",\"psv_expiry\":\"2017-06-30T23:00:00+00:00\",\"badge_type\":\"PRIVATE HIRE\",\"licence\":\"\",\"licence_expiry\":\"2017-04-20T15:10:00+00:00\",\"last_payment_date\":\"2017-04-20T15:10:00+00:00\",\"lat\":null,\"lng\":null,\"deleted\":\"0\",\"phone\":\"00447391685806\",\"vehicle\":{\"id\":\"220\",\"ref\":\"255\",\"a_k_a\":\"\",\"year\":\"2016\",\"reg\":\"sm66cmk\",\"plate\":\"309\",\"plate_expiry\":\"2017-12-04T00:00:00+00:00\",\"hire_expiry\":\"2017-05-03T09:11:00+00:00\",\"insurer\":null,\"insurance\":null,\"insurance_expiry\":\"2017-05-31T23:00:00+00:00\",\"nct\":null,\"nct_expiry\":\"2017-05-03T09:11:00+00:00\",\"road_tax_expiry\":\"2017-05-03T09:11:00+00:00\",\"make\":\"hyundai\",\"model\":\"i40\",\"colour\":\"grey\",\"vehicle_phone\":null}},\"vehicle\":{\"id\":\"220\",\"ref\":\"255\",\"a_k_a\":\"\",\"year\":\"2016\",\"reg\":\"sm66cmk\",\"plate\":\"309\",\"plate_expiry\":\"2017-12-04T00:00:00+00:00\",\"hire_expiry\":\"2017-05-03T09:11:00+00:00\",\"insurer\":null,\"insurance\":null,\"insurance_expiry\":\"2017-05-31T23:00:00+00:00\",\"nct\":null,\"nct_expiry\":\"2017-05-03T09:11:00+00:00\",\"road_tax_expiry\":\"2017-05-03T09:11:00+00:00\",\"make\":\"hyundai\",\"model\":\"i40\",\"colour\":\"grey\",\"vehicle_phone\":null},\"priority\":\"4\",\"attributegroup_id\":\"1\",\"site_id\":\"0\",\"fail_count\":\"0\",\"source\":\"IVR\",\"status\":\"COMPLETED\",\"status_text\":\"Your booking has been completed.\",\"fields\":[],\"vias\":[{\"id\":\"6587476\",\"lat\":53.739643,\"lng\":-0.414043,\"formatted\":\"38 Rokeby Avenue, Hull, Hull, Hu47na\",\"pickup_order\":\"1\",\"pickup_date\":null,\"name\":\"ANGELA\",\"type\":\"PICKUP\",\"phone\":\"00447743064497\",\"custom-fields\":[]}],\"route\":{\"actual\":\"3.65\",\"estimate\":\"0.00\",\"actual_duration\":\"00:19:37\",\"estimate_duration\":\"00:00:00\"},\"prebooked\":0,\"company\":\"57 Taxis Limited T\\/A Drive\",\"bookingreferrer\":null,\"_object_type\":\"archive\",\"language\":\"\",\"CO2_emissions\":441,\"unit\":\"g\\/km\"}},\"warnings\":[],\"nonce\":null}"
const respPreBookingOk = "{\"version\":243,\"code\":\"0\",\"body\":{\"booking\":{\"id\":\"3461787\",\"perma_id\":\"3408120\",\"sequence\":\"1\",\"trip_id\":\"3408120A\",\"created_date\":\"2019-11-03T12:35:02+00:00\",\"date\":\"2019-11-04T12:35:02+00:00\",\"pickup_date\":\"2019-11-04T12:35:02+00:00\",\"eta\":\"7\",\"expected_arrival_at\":\"2019-11-04T12:42:02+00:00\",\"booked_date\":\"2019-11-04T12:35:09+00:00\",\"arrive_date\":\"2019-11-04T12:31:29+00:00\",\"contact_date\":\"2019-11-04T12:32:18+00:00\",\"close_date\":\"2019-11-04T12:54:46+00:00\",\"operator_id\":\"0\",\"user_id\":\"2129298\",\"name\":\"ANGELA\",\"phone\":\"00447743064497\",\"account_id\":\"0\",\"account\":[],\"flight_number\":null,\"payment\":{\"id\":\"3508679\",\"tip\":0,\"tip_type\":\"ABSOLUTE\",\"tolls\":0,\"extras\":0,\"cost\":7.1,\"price\":7.1,\"fixed\":0,\"service_charge\":0,\"total\":7.1,\"order_id\":\"0\",\"card_id\":0,\"status\":\"PROCESSED\",\"fixedfare_id\":0,\"fixedfare\":[],\"fixedfare_alt\":0,\"tariff_id\":1,\"waiting\":0,\"waiting_cost\":0,\"waiting_price\":0,\"fee\":0,\"processed\":\"2019-11-04T12:54:46+00:00\",\"service_charge_value\":0,\"service_charge_type\":\"\",\"min_service_charge\":0,\"discount_price\":0,\"discount_price_type\":\"PERCENTAGE\",\"discount_cost\":0,\"discount_cost_type\":\"PERCENTAGE\",\"distance_charged\":3.6485,\"profile\":\"NORMAL\",\"driver_collects\":0,\"_deprecated_fields_\":[\"meter\",\"account_meter\",\"processing_fee\"],\"meter\":7.1,\"account_meter\":7.1,\"processing_fee\":0,\"voucher\":\"\",\"passengers\":0,\"discount\":0,\"price_after_discount\":7.1,\"cardpayments\":[]},\"payment_type\":\"CASH\",\"zone_id\":17,\"zone\":{\"id\":17,\"ref\":\"BOOTH NORTH\"},\"address\":{\"id\":\"11783992\",\"lat\":53.739643,\"lng\":-0.414043,\"actual_lat\":53.739643,\"actual_lng\":-0.414043,\"formatted\":\"38 ROKEBY AVENUE, HULL, HULL, HU47NA\",\"building_number\":\"38\",\"street\":\"ROKEBY AVENUE\",\"postcode\":\"HU47NA\"},\"destination\":{\"id\":\"11760120\",\"formatted\":\"BROOK STREET, HULL, HU28LA\",\"lat\":53.746079,\"lng\":-0.344922,\"actual_lat\":53.746079,\"actual_lng\":-0.344922,\"building_number\":null,\"street\":\"BROOK STREET\",\"postcode\":\"HU28LA\"},\"vehicle_type\":\"R4\",\"vehicle_group\":\"Taxi\",\"instructions\":\"\",\"driver_comment\":\"\",\"notes\":\" \",\"driver\":{\"id\":214,\"ref\":\"255\",\"active\":\"1\",\"name\":\"Steve Wiles\",\"mobile\":\"00447734469587\",\"email\":\"sophiewiles88@gmail.com\",\"photo\":\"https:\\/\\/s3-eu-west-1.amazonaws.com\\/icabbi.assets\\/images\\/consumergeneral\\/driver.png\",\"psv\":\"982\",\"psv_expiry\":\"2017-06-30T23:00:00+00:00\",\"badge_type\":\"PRIVATE HIRE\",\"licence\":\"\",\"licence_expiry\":\"2017-04-20T15:10:00+00:00\",\"last_payment_date\":\"2017-04-20T15:10:00+00:00\",\"lat\":null,\"lng\":null,\"deleted\":\"0\",\"phone\":\"00447391685806\",\"vehicle\":{\"id\":\"220\",\"ref\":\"255\",\"a_k_a\":\"\",\"year\":\"2016\",\"reg\":\"sm66cmk\",\"plate\":\"309\",\"plate_expiry\":\"2017-12-04T00:00:00+00:00\",\"hire_expiry\":\"2017-05-03T09:11:00+00:00\",\"insurer\":null,\"insurance\":null,\"insurance_expiry\":\"2017-05-31T23:00:00+00:00\",\"nct\":null,\"nct_expiry\":\"2017-05-03T09:11:00+00:00\",\"road_tax_expiry\":\"2017-05-03T09:11:00+00:00\",\"make\":\"hyundai\",\"model\":\"i40\",\"colour\":\"grey\",\"vehicle_phone\":null}},\"vehicle\":{\"id\":\"220\",\"ref\":\"255\",\"a_k_a\":\"\",\"year\":\"2016\",\"reg\":\"sm66cmk\",\"plate\":\"309\",\"plate_expiry\":\"2017-12-04T00:00:00+00:00\",\"hire_expiry\":\"2017-05-03T09:11:00+00:00\",\"insurer\":null,\"insurance\":null,\"insurance_expiry\":\"2017-05-31T23:00:00+00:00\",\"nct\":null,\"nct_expiry\":\"2017-05-03T09:11:00+00:00\",\"road_tax_expiry\":\"2017-05-03T09:11:00+00:00\",\"make\":\"hyundai\",\"model\":\"i40\",\"colour\":\"grey\",\"vehicle_phone\":null},\"priority\":\"4\",\"attributegroup_id\":\"1\",\"site_id\":\"0\",\"fail_count\":\"0\",\"source\":\"IVR\",\"status\":\"COMPLETED\",\"status_text\":\"Your booking has been completed.\",\"fields\":[],\"vias\":[{\"id\":\"6587476\",\"lat\":53.739643,\"lng\":-0.414043,\"formatted\":\"38 Rokeby Avenue, Hull, Hull, Hu47na\",\"pickup_order\":\"1\",\"pickup_date\":null,\"name\":\"ANGELA\",\"type\":\"PICKUP\",\"phone\":\"00447743064497\",\"custom-fields\":[]}],\"route\":{\"actual\":\"3.65\",\"estimate\":\"0.00\",\"actual_duration\":\"00:19:37\",\"estimate_duration\":\"00:00:00\"},\"prebooked\":0,\"company\":\"57 Taxis Limited T\\/A Drive\",\"bookingreferrer\":null,\"_object_type\":\"archive\",\"language\":\"\",\"CO2_emissions\":441,\"unit\":\"g\\/km\"}},\"warnings\":[],\"nonce\":null}"
const respPreBookingNotOk = "{\"version\":243,\"code\":\"0\",\"body\":{\"booking\":{\"id\":\"3461787\",\"perma_id\":\"3408120\",\"sequence\":\"1\",\"trip_id\":\"3408120A\",\"created_date\":\"2019-11-03T12:35:02+00:00\",\"date\":\"2019-11-04T12:35:02+00:00\",\"pickup_date\":\"2019-11-04T12:35:02+00:00\",\"eta\":\"7\",\"expected_arrival_at\":\"2019-11-04T12:42:02+00:00\",\"booked_date\":\"2019-11-04T12:35:09+00:00\",\"arrive_date\":\"2019-11-04T12:37:29+00:00\",\"contact_date\":\"2019-11-04T12:39:18+00:00\",\"close_date\":\"2019-11-04T12:54:46+00:00\",\"operator_id\":\"0\",\"user_id\":\"2129298\",\"name\":\"ANGELA\",\"phone\":\"00447743064497\",\"account_id\":\"0\",\"account\":[],\"flight_number\":null,\"payment\":{\"id\":\"3508679\",\"tip\":0,\"tip_type\":\"ABSOLUTE\",\"tolls\":0,\"extras\":0,\"cost\":7.1,\"price\":7.1,\"fixed\":0,\"service_charge\":0,\"total\":7.1,\"order_id\":\"0\",\"card_id\":0,\"status\":\"PROCESSED\",\"fixedfare_id\":0,\"fixedfare\":[],\"fixedfare_alt\":0,\"tariff_id\":1,\"waiting\":0,\"waiting_cost\":0,\"waiting_price\":0,\"fee\":0,\"processed\":\"2019-11-04T12:54:46+00:00\",\"service_charge_value\":0,\"service_charge_type\":\"\",\"min_service_charge\":0,\"discount_price\":0,\"discount_price_type\":\"PERCENTAGE\",\"discount_cost\":0,\"discount_cost_type\":\"PERCENTAGE\",\"distance_charged\":3.6485,\"profile\":\"NORMAL\",\"driver_collects\":0,\"_deprecated_fields_\":[\"meter\",\"account_meter\",\"processing_fee\"],\"meter\":7.1,\"account_meter\":7.1,\"processing_fee\":0,\"voucher\":\"\",\"passengers\":0,\"discount\":0,\"price_after_discount\":7.1,\"cardpayments\":[]},\"payment_type\":\"CASH\",\"zone_id\":17,\"zone\":{\"id\":17,\"ref\":\"BOOTH NORTH\"},\"address\":{\"id\":\"11783992\",\"lat\":53.739643,\"lng\":-0.414043,\"actual_lat\":53.739643,\"actual_lng\":-0.414043,\"formatted\":\"38 ROKEBY AVENUE, HULL, HULL, HU47NA\",\"building_number\":\"38\",\"street\":\"ROKEBY AVENUE\",\"postcode\":\"HU47NA\"},\"destination\":{\"id\":\"11760120\",\"formatted\":\"BROOK STREET, HULL, HU28LA\",\"lat\":53.746079,\"lng\":-0.344922,\"actual_lat\":53.746079,\"actual_lng\":-0.344922,\"building_number\":null,\"street\":\"BROOK STREET\",\"postcode\":\"HU28LA\"},\"vehicle_type\":\"R4\",\"vehicle_group\":\"Taxi\",\"instructions\":\"\",\"driver_comment\":\"\",\"notes\":\" \",\"driver\":{\"id\":214,\"ref\":\"255\",\"active\":\"1\",\"name\":\"Steve Wiles\",\"mobile\":\"00447734469587\",\"email\":\"sophiewiles88@gmail.com\",\"photo\":\"https:\\/\\/s3-eu-west-1.amazonaws.com\\/icabbi.assets\\/images\\/consumergeneral\\/driver.png\",\"psv\":\"982\",\"psv_expiry\":\"2017-06-30T23:00:00+00:00\",\"badge_type\":\"PRIVATE HIRE\",\"licence\":\"\",\"licence_expiry\":\"2017-04-20T15:10:00+00:00\",\"last_payment_date\":\"2017-04-20T15:10:00+00:00\",\"lat\":null,\"lng\":null,\"deleted\":\"0\",\"phone\":\"00447391685806\",\"vehicle\":{\"id\":\"220\",\"ref\":\"255\",\"a_k_a\":\"\",\"year\":\"2016\",\"reg\":\"sm66cmk\",\"plate\":\"309\",\"plate_expiry\":\"2017-12-04T00:00:00+00:00\",\"hire_expiry\":\"2017-05-03T09:11:00+00:00\",\"insurer\":null,\"insurance\":null,\"insurance_expiry\":\"2017-05-31T23:00:00+00:00\",\"nct\":null,\"nct_expiry\":\"2017-05-03T09:11:00+00:00\",\"road_tax_expiry\":\"2017-05-03T09:11:00+00:00\",\"make\":\"hyundai\",\"model\":\"i40\",\"colour\":\"grey\",\"vehicle_phone\":null}},\"vehicle\":{\"id\":\"220\",\"ref\":\"255\",\"a_k_a\":\"\",\"year\":\"2016\",\"reg\":\"sm66cmk\",\"plate\":\"309\",\"plate_expiry\":\"2017-12-04T00:00:00+00:00\",\"hire_expiry\":\"2017-05-03T09:11:00+00:00\",\"insurer\":null,\"insurance\":null,\"insurance_expiry\":\"2017-05-31T23:00:00+00:00\",\"nct\":null,\"nct_expiry\":\"2017-05-03T09:11:00+00:00\",\"road_tax_expiry\":\"2017-05-03T09:11:00+00:00\",\"make\":\"hyundai\",\"model\":\"i40\",\"colour\":\"grey\",\"vehicle_phone\":null},\"priority\":\"4\",\"attributegroup_id\":\"1\",\"site_id\":\"0\",\"fail_count\":\"0\",\"source\":\"IVR\",\"status\":\"COMPLETED\",\"status_text\":\"Your booking has been completed.\",\"fields\":[],\"vias\":[{\"id\":\"6587476\",\"lat\":53.739643,\"lng\":-0.414043,\"formatted\":\"38 Rokeby Avenue, Hull, Hull, Hu47na\",\"pickup_order\":\"1\",\"pickup_date\":null,\"name\":\"ANGELA\",\"type\":\"PICKUP\",\"phone\":\"00447743064497\",\"custom-fields\":[]}],\"route\":{\"actual\":\"3.65\",\"estimate\":\"0.00\",\"actual_duration\":\"00:19:37\",\"estimate_duration\":\"00:00:00\"},\"prebooked\":0,\"company\":\"57 Taxis Limited T\\/A Drive\",\"bookingreferrer\":null,\"_object_type\":\"archive\",\"language\":\"\",\"CO2_emissions\":441,\"unit\":\"g\\/km\"}},\"warnings\":[],\"nonce\":null}"
const respBookingNoShowNotOk = "{\"version\":243,\"code\":\"0\",\"body\":{\"booking\":{\"id\":\"3726779\",\"perma_id\":\"3668874\",\"sequence\":\"1\",\"trip_id\":\"3668874A\",\"created_date\":\"2019-12-16T09:46:46+00:00\",\"date\":\"2019-12-16T09:46:46+00:00\",\"pickup_date\":\"2019-12-16T09:46:46+00:00\",\"eta\":\"0\",\"expected_arrival_at\":\"2019-12-16T09:46:46+00:00\",\"booked_date\":\"2019-12-16T09:49:59+00:00\",\"arrive_date\":\"2019-12-16T09:51:59+00:00\",\"contact_date\":\"2019-12-16T10:00:16+00:00\",\"close_date\":\"2019-12-16T10:00:16+00:00\",\"operator_id\":\"2115357\",\"user_id\":\"2231735\",\"name\":\"ALEX ROOM 305\",\"phone\":\"01482755500\",\"account_id\":\"0\",\"account\":[],\"flight_number\":null,\"payment\":{\"id\":\"3783185\",\"tip\":0,\"tip_type\":\"ABSOLUTE\",\"tolls\":0,\"extras\":0,\"cost\":0,\"price\":0,\"fixed\":0,\"service_charge\":0,\"total\":0,\"order_id\":null,\"card_id\":0,\"status\":\"NEW\",\"fixedfare_id\":0,\"fixedfare\":[],\"fixedfare_alt\":0,\"tariff_id\":1,\"waiting\":0,\"waiting_cost\":0,\"waiting_price\":0,\"fee\":0,\"processed\":0,\"service_charge_value\":0,\"service_charge_type\":\"\",\"min_service_charge\":0,\"discount_price\":0,\"discount_price_type\":\"PERCENTAGE\",\"discount_cost\":0,\"discount_cost_type\":\"PERCENTAGE\",\"distance_charged\":0,\"profile\":\"NORMAL\",\"driver_collects\":0,\"_deprecated_fields_\":[\"meter\",\"account_meter\",\"processing_fee\"],\"meter\":0,\"account_meter\":0,\"processing_fee\":10,\"voucher\":\"\",\"passengers\":1,\"discount\":0,\"price_after_discount\":0,\"cardpayments\":[]},\"payment_type\":\"CASH\",\"zone_id\":2,\"zone\":{\"id\":2,\"ref\":\"NEW TOWN\"},\"address\":{\"id\":\"128007586\",\"lat\":53.747717,\"lng\":-0.346906,\"actual_lat\":53.747717,\"actual_lng\":-0.346906,\"formatted\":\"DOUBLE TREE BY HILTON HOTEL, FERENSWAY , HULL, HU28NH\",\"building_number\":null,\"street\":\"DOUBLE TREE BY HILTON HOTEL\",\"postcode\":\"HU28NH\"},\"destination\":{\"id\":\"29583688\",\"formatted\":\"KING GEORGE DOCK, HULL, HU95PR\",\"lat\":53.740975,\"lng\":-0.27428,\"actual_lat\":53.740975,\"actual_lng\":-0.27428,\"building_number\":null,\"street\":\"KING GEORGE DOCK\",\"postcode\":\"HU95PR\"},\"vehicle_type\":\"R4\",\"vehicle_group\":\"Taxi\",\"instructions\":\"COLLECT PASSENGER FROM INSIDE RECEPTION\",\"driver_comment\":\"\",\"notes\":\"CHECK THAT DRIVER HAS GONE INTO RECEPTION BEFORE NO SHOWING \",\"driver\":{\"id\":179,\"ref\":\"217\",\"active\":\"1\",\"name\":\"Sarko Faraidon\",\"mobile\":\"00447578106203\",\"email\":\"sssarko@hotmail.com\",\"photo\":\"https:\\/\\/s3-eu-west-1.amazonaws.com\\/icabbi.assets\\/images\\/consumergeneral\\/driver.png\",\"psv\":\"1590\",\"psv_expiry\":\"2020-06-30T22:59:59+00:00\",\"badge_type\":\"PRIVATE HIRE\",\"licence\":\"\",\"licence_expiry\":\"2020-06-30T22:59:59+00:00\",\"last_payment_date\":\"2017-04-20T08:03:00+00:00\",\"lat\":null,\"lng\":null,\"deleted\":\"0\",\"phone\":\"00447341738176\",\"vehicle\":{\"id\":\"183\",\"ref\":\"217\",\"a_k_a\":\"\",\"year\":\"2016\",\"reg\":\"LL61 ZXC\",\"plate\":\"593\",\"plate_expiry\":\"2020-06-30T22:59:59+00:00\",\"hire_expiry\":\"2019-11-25T11:56:17+00:00\",\"insurer\":null,\"insurance\":null,\"insurance_expiry\":\"2020-06-08T22:59:59+00:00\",\"nct\":null,\"nct_expiry\":\"2020-04-09T22:59:59+00:00\",\"road_tax_expiry\":\"2019-11-25T11:56:17+00:00\",\"make\":\"VAUXHALL\",\"model\":\"ASTRA\",\"colour\":\"Silver\",\"vehicle_phone\":null}},\"vehicle\":{\"id\":\"183\",\"ref\":\"217\",\"a_k_a\":\"\",\"year\":\"2016\",\"reg\":\"LL61 ZXC\",\"plate\":\"593\",\"plate_expiry\":\"2020-06-30T22:59:59+00:00\",\"hire_expiry\":\"2019-11-25T11:56:17+00:00\",\"insurer\":null,\"insurance\":null,\"insurance_expiry\":\"2020-06-08T22:59:59+00:00\",\"nct\":null,\"nct_expiry\":\"2020-04-09T22:59:59+00:00\",\"road_tax_expiry\":\"2019-11-25T11:56:17+00:00\",\"make\":\"VAUXHALL\",\"model\":\"ASTRA\",\"colour\":\"Silver\",\"vehicle_phone\":null},\"priority\":\"5\",\"attributegroup_id\":\"1\",\"site_id\":\"0\",\"fail_count\":\"0\",\"source\":\"DISPATCH\",\"status\":\"NOSHOW\",\"status_text\":\"Your driver could not find you, if this was in error please contact us to book again\",\"fields\":[],\"vias\":[{\"id\":\"7132469\",\"lat\":53.747717,\"lng\":-0.346906,\"formatted\":\"Double Tree By Hilton Hotel, Ferensway , Hull, Hu28nh\",\"pickup_order\":\"1\",\"pickup_date\":null,\"name\":\"ALEX ROOM 305\",\"type\":\"PICKUP\",\"phone\":\"01482755500\",\"custom-fields\":[]}],\"route\":{\"actual\":\"0.00\",\"estimate\":\"0.00\",\"actual_duration\":\"00:10:17\",\"estimate_duration\":\"00:00:00\",\"estimate_fare\":\"0.00\"},\"prebooked\":0,\"company\":\"57 Taxis Limited T\\/A Drive\",\"bookingreferrer\":null,\"_object_type\":\"archive\",\"language\":\"\",\"CO2_emissions\":0,\"unit\":\"g\\/km\"}},\"warnings\":[],\"nonce\":null}"
const responseBookingErrorUnmarshalling = "{\"version\":243,\"error\":true,\"code\":400,\"message\":\"Please specify an ID\",\"warnings\":[],\"body\":[]}"

func TestBookingResponse(t *testing.T) {
	rJson := BookingResponse{}
	if errJson := json.Unmarshal([]byte(respBookingNowOk), &rJson); errJson != nil {
		log.Printf("Error unmarshalling JSON for booking from iCabbi API , response from server: %v, error: %v", respBookingNowOk, errJson)
	}
	fmt.Println("code: ", rJson.Code)
	fmt.Println("Status: ", rJson.Body.Booking.Status)
	fmt.Println("CreatedDate: ", rJson.Body.Booking.CreatedDate)
	fmt.Println("PickupDate: ", rJson.Body.Booking.PickupDate)
	// fmt.Println("ArriveDate: ", rJson.Body.Booking.ArriveDate)
	fmt.Println("ContactDate: ", rJson.Body.Booking.ContactDate)
}

func TestRetrieveBooking(t *testing.T) {
	resp := RetrieveBooking(testIcabbiURL, testIcabbiAppKey, testIcabbiSecretKey, testIcabbiTripID)
	fmt.Println("resp: ", resp)
}

func TestCheckBookingNowOK(t *testing.T) {
	ck := CheckBooking(respBookingNowOk, testIcabbiTripID, 10, 10, 3, 1)
	fmt.Println("ck: ", ck)
	if !ck {
		t.Fatal("Error should be true")
	}
}

func TestCheckBookingNowNotOK(t *testing.T) {
	ck := CheckBooking(respBookingNowNotOk, testIcabbiTripID, 10, 10, 3, 1)
	fmt.Println("ck: ", ck)
	if ck {
		t.Fatal("Error should be false")
	}
}

func TestCheckPreBookingOK(t *testing.T) {
	ck := CheckBooking(respPreBookingOk, testIcabbiTripID, 10, 10, 3, 1)
	fmt.Println("ck: ", ck)
	if !ck {
		t.Fatal("Error should be true")
	}
}

func TestCheckPreBookingNotOK(t *testing.T) {
	ck := CheckBooking(respPreBookingNotOk, testIcabbiTripID, 10, 10, 3, 1)
	fmt.Println("ck: ", ck)
	if ck {
		t.Fatal("Error should be false")
	}
}

func TestCheckBookingNowNoShowNotOK(t *testing.T) {
	ck := CheckBooking(respBookingNoShowNotOk, testIcabbiNoShowTripID, 10, 10, 3, 1)
	fmt.Println("ck: ", ck)
	if ck {
		t.Fatal("Error should be false")
	}
}

func TestCheckBookingErrorUnmarshalling(t *testing.T) {
	ck := CheckBooking(responseBookingErrorUnmarshalling, testIcabbiNoShowTripID, 10, 10, 3, 1)
	fmt.Println("ck: ", ck)
	if ck {
		t.Fatal("Error should be false")
	}
}

func TestBookingOkNow(t *testing.T) {
	ok := BookingOk(testIcabbiURL, testIcabbiAppKey, testIcabbiSecretKey, testIcabbiTripID, 10, 10, 3, 1)
	fmt.Println("ok: ", ok)
}

func TestBookingOkNowNoShow(t *testing.T) {
	ok := BookingOk(testIcabbiURL, testIcabbiAppKey, testIcabbiSecretKey, testIcabbiNoShowTripID, 10, 10, 3, 1)
	fmt.Println("ok: ", ok)
}
